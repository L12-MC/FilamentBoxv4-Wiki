<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FilamentBox Generator</title>
<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<style>
  body.dark-mode {
    background-color: #121212;
    color: white;
  }
  .viewer {
    width: 100%;
    height: 650px;
    background: #222;
    border-radius: 12px;
  }
  .center-img {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: auto;
    height: 100%;
  }
  
</style>
</head>
<body class="p-3">
<div class="d-flex justify-content-between mb-3">
  <h1>FilamentBoxV4 Generator</h1>
  <button id="backButton" class="btn btn-primary mt-3">Back To Wiki</button>
</div>
<div class="card">
  <div class="card-header">Configuration</div>
  <div class="card-body">
    <label class="form-label">Select Length</label>
    <select id="lengthSelect" class="form-select mb-3">
      <option value="1">1 Long</option>
      <option value="2">2 Long</option>
      <option value="3">3 Long</option>
      <option value="4">4 Long</option>
    </select>
    <div><strong>Bearings Needed:</strong> <span id="bearingCount">4</span></div>
    <button id="downloadBtn" class="btn btn-primary mt-3">Download STL Files</button>
  </div>
</div>
<div class="card mt-3">
  <div class="card-header">Preview</div>
  <div class="card-body">
    <div id="viewer" class="viewer"><img src="preview/images/1_spool.png" id="viewerImg" alt="assembly preview" class="center-img"></div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
window.addEventListener('load', () => {
  const configMap = {
    1: { rollers: 2, bearings: 4, parts: ['Base - No Hole - No Click.stl'] },
    2: { rollers: 4, bearings: 8, parts: ['Base - No Hole.stl', 'Base - No Click.stl'] },
    3: { rollers: 6, bearings: 12, parts: ['Base - No Hole.stl', 'Base.stl', 'Base - No Click.stl'] },
    4: { rollers: 8, bearings: 16, parts: ['Base - No Hole.stl', 'Base.stl2', 'Base - No Click.stl'] }
  };



  const partFiles = {
    'Base - No Hole - No Click.stl': 'stl/base_nohole_noclick.stl',
    'Base - No Hole.stl': 'stl/base_nohole.stl',
    'Base.stl': 'stl/base.stl',
    'Base.stl2': 'stl/base_x2.stl',
    'Base - No Click.stl': 'stl/base_noclick.stl',
    'Roller': 'stl/roller.stl'
  };

  const bearingCountEl = document.getElementById('bearingCount');
  const lengthSelect = document.getElementById('lengthSelect');
  const downloadBtn = document.getElementById('downloadBtn');
  const backButton = document.getElementById('backButton');
  const previewImage = document.getElementById('viewerImg')

  backButton.addEventListener('click', () => {
    window.location.href = 'index.html';
  });


  lengthSelect.addEventListener('change', updateConfig);

  function updateConfig() {
    const len = parseInt(lengthSelect.value);
    const cfg = configMap[len];
    bearingCountEl.textContent = cfg.bearings;
    if (lengthSelect.value == 1) {
      previewImage.src = 'preview/images/1_spool.png'
    }
    if (lengthSelect.value == 2) {
      previewImage.src = 'preview/images/2_spools.png'
    }
    if (lengthSelect.value == 3) {
      previewImage.src = 'preview/images/3_spools.png'
    }
    if (lengthSelect.value == 4) {
      previewImage.src = 'preview/images/4_spools.png'
    }
  }

  downloadBtn.addEventListener('click', async () => {
    try {
      const len = parseInt(lengthSelect.value, 10);
      const cfg = configMap[len];
      if (!cfg) throw new Error(`No config for length ${len}`);

      const zip = new JSZip();

      // Gather all fetches first
      const filePromises = [];

      // Base parts
      for (const partName of cfg.parts) {
        const url = partFiles[partName];
        if (!url) continue;
        const name = url.split('/').pop();
        filePromises.push(fetchBlob(url).then(blob => ({ name, blob })));
      }

      // Roller
      if (partFiles['Roller']) {
        const rollerName = `roller_x${cfg.rollers}.stl`;
        filePromises.push(fetchBlob(partFiles['Roller']).then(blob => ({ name: rollerName, blob })));
      }

      const bomUrl = `bom/bom_${len}_spool.csv`; // This is the source file URL
      filePromises.push(fetchBlob(bomUrl).then(blob => ({
        name: `bom_${len}_spool.csv`, // Save as CSV in the ZIP
        blob
      })));

      // Wait for all files, then add to zip
      const files = await Promise.all(filePromises);
      for (const { name, blob } of files) {
        zip.file(name, blob);
      }

      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, `FilamentBoxV4_${len}long.zip`);
    } catch (err) {
      console.error(err);
      alert(`Couldn't build zip: ${err.message}`);
    }
  });

  async function fetchBlob(url) {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`Failed to fetch ${url} (${resp.status})`);
    return await resp.blob();
  }



  

  // Load default assembly on start
  updateConfig();
});
</script>
</body>
</html>
