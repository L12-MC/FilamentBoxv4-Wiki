<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FilamentBox Generator</title>
<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<style>
  body.dark-mode {
    background-color: #121212;
    color: white;
  }
  .viewer {
    width: 100%;
    height: 400px;
    background: #222;
  }
</style>
</head>
<body class="p-3">
<div class="d-flex justify-content-between mb-3">
  <h1>FilamentBoxV4 Generator</h1>
  <button id="backButton" class="btn btn-secondary">Back To Wiki</button>
</div>
<div class="card">
  <div class="card-header">Configuration</div>
  <div class="card-body">
    <label class="form-label">Select Length</label>
    <select id="lengthSelect" class="form-select mb-3">
      <option value="1">1 Long</option>
      <option value="2">2 Long</option>
      <option value="3">3 Long</option>
      <option value="4">4 Long</option>
    </select>
    <div><strong>Bearings Needed:</strong> <span id="bearingCount">4</span></div>
    <button id="downloadBtn" class="btn btn-primary mt-3">Download STL Files</button>
  </div>
</div>
<div class="card mt-3">
  <div class="card-header">3D Preview</div>
  <div class="card-body">
    <div id="viewer" class="viewer"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/STPLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
window.addEventListener('load', () => {
  const configMap = {
    1: { rollers: 2, bearings: 4, parts: ['Base - No Hole - No Click.stl'] },
    2: { rollers: 4, bearings: 8, parts: ['Base - No Hole.stl', 'Base - No Click.stl'] },
    3: { rollers: 6, bearings: 12, parts: ['Base - No Hole.stl', 'Base.stl', 'Base - No Click.stl'] },
    4: { rollers: 8, bearings: 16, parts: ['Base - No Hole.stl', 'Base.stl2', 'Base - No Click.stl'] }
  };



  const partFiles = {
    'Base - No Hole - No Click.stl': 'stl/base_nohole_noclick.stl',
    'Base - No Hole.stl': 'stl/base_nohole.stl',
    'Base.stl': 'stl/base.stl',
    'Base.stl2': 'stl/base_x2.stl',
    'Base - No Click.stl': 'stl/base_noclick.stl',
    'Roller': 'stl/roller.stl'
  };

  const bearingCountEl = document.getElementById('bearingCount');
  const lengthSelect = document.getElementById('lengthSelect');
  const downloadBtn = document.getElementById('downloadBtn');
  const backButton = document.getElementById('backButton');

  backButton.addEventListener('click', () => {
    window.location.href = 'index.html';
  });


  lengthSelect.addEventListener('change', updateConfig);

  function updateConfig() {
    const len = parseInt(lengthSelect.value);
    const cfg = configMap[len];
    bearingCountEl.textContent = cfg.bearings;

    clearScene();
    loadStepPreview();
  }

  downloadBtn.addEventListener('click', async () => {
    const len = parseInt(lengthSelect.value);
    const cfg = configMap[len];
    const zip = new JSZip();

    // Add base parts
    cfg.parts.forEach(partName => {
      if (partFiles[partName]) {
        zip.file(partFiles[partName].split('/').pop(), fetchSync(partFiles[partName]));
      }
    });

    // Add rollers
    
    zip.file(`roller_x${cfg.rollers}.stl`, fetchSync(partFiles['Roller']));
    

    const content = await zip.generateAsync({ type: 'blob' });
    saveAs(content, `FilamentBoxV4_${len}long.zip`);
  });

  async function fetchSync(url) {
    const resp = await fetch(url);
    return await resp.blob();
  }

  // THREE.js setup
  const viewerEl = document.getElementById('viewer');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, viewerEl.clientWidth / viewerEl.clientHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(viewerEl.clientWidth, viewerEl.clientHeight);
  viewerEl.appendChild(renderer.domElement);
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  camera.position.set(0, 0, 200);
  controls.update();
  scene.add(new THREE.AmbientLight(0xffffff, 0.8));

  const stepLoader = new THREE.STPLoader();

  function loadStepPreview() {
    stepLoader.load('preview/Assembly4Spool.step', object => {
      object.traverse(child => {
        if (child.isMesh) child.material = new THREE.MeshPhongMaterial({ color: 0x8888ff });
      });
      scene.add(object);
    });
  }

  function clearScene() {
    for (let i = scene.children.length - 1; i >= 0; i--) {
      if (scene.children[i].type === 'Mesh' || scene.children[i].type === 'Group') {
        scene.remove(scene.children[i]);
      }
    }
  }

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  // Load default assembly on start
  updateConfig();
});
</script>
</body>
</html>
